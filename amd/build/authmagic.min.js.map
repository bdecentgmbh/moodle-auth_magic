{"version":3,"file":"authmagic.min.js","sources":["../src/authmagic.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Magic authentication define js.\n * @module   auth_magic\n * @copyright  2023 bdecent gmbh <https://bdecent.de>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str'],\nfunction(String) {\n\n   /**\n    * Controls Custom styles tool action.\n    * @param {object} params\n    */\n   var AuthMagic = function(params) {\n       var self = this;\n       if (params.loginhook) {\n           self.magicLoginHook(params);\n       }\n       return true;\n   };\n\n   AuthMagic.prototype.magicLoginHook = function(params) {\n       var authSelector = \"#page-login-index .potentialidplist a[title=\\\"\" + params.strbutton + \"\\\"]\";\n       if (authSelector) {\n           var getMagicLink = document.querySelectorAll(authSelector)[0];\n           var potentialiDp = document.querySelector(\"#page-login-index .potentialidplist\");\n           if (potentialiDp) {\n               potentialiDp = potentialiDp.previousElementSibling;\n           }\n           var potentialiDpList = document.querySelectorAll(\"#page-login-index .potentialidplist .potentialidp\");\n           if (getMagicLink === undefined) {\n               authSelector = \"#page-login-index .login-identityproviders a\";\n               var getMagicLinks = document.querySelectorAll(authSelector);\n               if (getMagicLinks.length) {\n                   getMagicLinks.forEach(function(item) {\n                       var inner = item.innerHTML.trim();\n                       if (inner == params.strbutton) {\n                           getMagicLink = item;\n                           potentialiDpList = document.querySelectorAll(\"#page-login-index .login-identityproviders a\");\n                           potentialiDp = document.querySelectorAll(\"#page-login-index .login-identityproviders h2\")[0];\n                       }\n                   });\n               }\n           }\n            if (getMagicLink) {\n\n                if (!document.querySelector(\"#page-login-index .potentialidplist\")) {\n                    getMagicLink.classList.remove(\"btn-secondary\");\n                    getMagicLink.classList.add(\"btn-primary\");\n                }\n                if (!params.linkbtnpos) {\n                    params.linkbtnpos = 0;\n                }\n                if (params.linkbtnpos == 0) {\n                    var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\n                    if (MagicLinkBlock) {\n                        MagicLinkBlock.appendChild(getMagicLink);\n                        // Create a span.\n                        var span = document.createElement(\"span\");\n                        span.setAttribute(\"class\", \"magic-password-instruction\");\n                        var passInfo = String.get_string('passinfo', 'auth_magic');\n                        passInfo.done(function(localizedEditString) {\n                            span.innerHTML = localizedEditString;\n                        });\n                        MagicLinkBlock.appendChild(span);\n                    }\n                }\n                if (params.linkbtnpos == 1) {\n                    var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\n                    if (MagicLinkBlock) {\n                        MagicLinkBlock.appendChild(getMagicLink);\n                    }\n                }\n\n                if (params.linkbtnpos <= 1 ) {\n                    if (potentialiDpList.length <= 1) {\n                        potentialiDp.style.display = 'none';\n                        var identityProvider = document.querySelectorAll(\"#page-login-index .login-identityproviders\")[0];\n                        if (identityProvider) {\n                            identityProvider.previousElementSibling.style.display = 'none';\n                            identityProvider.nextElementSibling.style.display = 'none';\n                        }\n                    }\n                }\n\n                if (params.linkbtnpos == 2) {\n                    getMagicLink.classList.remove(\"btn-primary\");\n                }\n                getMagicLink.addEventListener(\"click\", function(e) {\n                    e.preventDefault();\n                    var returnurl = e.currentTarget.getAttribute(\"href\");\n                    var userValue = \"\";\n                    var mailSelector = document.querySelectorAll(\"form#login #username\")[0];\n                    if (mailSelector) {\n                        userValue = mailSelector.value;\n                    }\n                    // Create a form.\n                    var form = document.createElement(\"form\");\n                    form.setAttribute(\"method\", \"post\");\n                    form.setAttribute(\"action\", returnurl);\n                    form.setAttribute(\"id\", \"magic-login-form\");\n\n                        // Create an input element for Full Name\n                    var magicLogin = document.createElement(\"input\");\n                    magicLogin.setAttribute(\"type\", \"hidden\");\n                    magicLogin.setAttribute(\"name\", \"magiclogin\");\n                    magicLogin.setAttribute(\"value\", 1);\n\n                    var uservalue = document.createElement(\"input\");\n                    uservalue.setAttribute(\"type\", \"hidden\");\n                    uservalue.setAttribute(\"name\", \"uservalue\");\n                    uservalue.setAttribute(\"value\", userValue);\n\n                    form.appendChild(magicLogin);\n                    form.appendChild(uservalue);\n\n                    getMagicLink.parentNode.appendChild(form);\n\n                    var magicForm = document.querySelectorAll(\"form#magic-login-form\")[0];\n                    magicForm.submit();\n                });\n           }\n       }\n   };\n\n   return {\n       init: function(params) {\n           return new AuthMagic(params);\n       }\n   };\n\n});"],"names":["define","String","AuthMagic","params","loginhook","this","magicLoginHook","prototype","authSelector","strbutton","getMagicLink","document","querySelectorAll","potentialiDp","querySelector","previousElementSibling","potentialiDpList","undefined","getMagicLinks","length","forEach","item","innerHTML","trim","MagicLinkBlock","classList","remove","add","linkbtnpos","appendChild","span","createElement","setAttribute","get_string","done","localizedEditString","style","display","identityProvider","nextElementSibling","addEventListener","e","preventDefault","returnurl","currentTarget","getAttribute","userValue","mailSelector","value","form","magicLogin","uservalue","parentNode","submit","init"],"mappings":";;;;;;AAsBAA,8BAAO,CAAC,aACR,SAASC,YAMFC,UAAY,SAASC,eAEjBA,OAAOC,WADAC,KAEFC,eAAeH,SAEjB,UAGXD,UAAUK,UAAUD,eAAiB,SAASH,YACtCK,aAAe,gDAAmDL,OAAOM,UAAY,QACrFD,aAAc,KACVE,aAAeC,SAASC,iBAAiBJ,cAAc,GACvDK,aAAeF,SAASG,cAAc,uCACtCD,eACAA,aAAeA,aAAaE,4BAE5BC,iBAAmBL,SAASC,iBAAiB,6DAC5BK,IAAjBP,aAA4B,CAC5BF,aAAe,mDACXU,cAAgBP,SAASC,iBAAiBJ,cAC1CU,cAAcC,QACdD,cAAcE,SAAQ,SAASC,MACfA,KAAKC,UAAUC,QACdpB,OAAOM,YAChBC,aAAeW,KACfL,iBAAmBL,SAASC,iBAAiB,gDAC7CC,aAAeF,SAASC,iBAAiB,iDAAiD,UAKrGF,aAAc,KAwBNc,kBAtBHb,SAASG,cAAc,yCACxBJ,aAAae,UAAUC,OAAO,iBAC9BhB,aAAae,UAAUE,IAAI,gBAE1BxB,OAAOyB,aACRzB,OAAOyB,WAAa,GAEC,GAArBzB,OAAOyB,cACHJ,eAAiBb,SAASC,iBAAiB,4CAA4CT,OAAOyB,YAC9E,CAChBJ,eAAeK,YAAYnB,kBAEvBoB,KAAOnB,SAASoB,cAAc,QAClCD,KAAKE,aAAa,QAAS,8BACZ/B,OAAOgC,WAAW,WAAY,cACpCC,MAAK,SAASC,qBACnBL,KAAKR,UAAYa,uBAErBX,eAAeK,YAAYC,SAGV,GAArB3B,OAAOyB,YACHJ,eAAiBb,SAASC,iBAAiB,4CAA4CT,OAAOyB,cAE9FJ,eAAeK,YAAYnB,iBAI/BP,OAAOyB,YAAc,GACjBZ,iBAAiBG,QAAU,EAAG,CAC9BN,aAAauB,MAAMC,QAAU,WACzBC,iBAAmB3B,SAASC,iBAAiB,8CAA8C,GAC3F0B,mBACAA,iBAAiBvB,uBAAuBqB,MAAMC,QAAU,OACxDC,iBAAiBC,mBAAmBH,MAAMC,QAAU,QAKvC,GAArBlC,OAAOyB,YACPlB,aAAae,UAAUC,OAAO,eAElChB,aAAa8B,iBAAiB,SAAS,SAASC,GAC5CA,EAAEC,qBACEC,UAAYF,EAAEG,cAAcC,aAAa,QACzCC,UAAY,GACZC,aAAepC,SAASC,iBAAiB,wBAAwB,GACjEmC,eACAD,UAAYC,aAAaC,WAGzBC,KAAOtC,SAASoB,cAAc,QAClCkB,KAAKjB,aAAa,SAAU,QAC5BiB,KAAKjB,aAAa,SAAUW,WAC5BM,KAAKjB,aAAa,KAAM,wBAGpBkB,WAAavC,SAASoB,cAAc,SACxCmB,WAAWlB,aAAa,OAAQ,UAChCkB,WAAWlB,aAAa,OAAQ,cAChCkB,WAAWlB,aAAa,QAAS,OAE7BmB,UAAYxC,SAASoB,cAAc,SACvCoB,UAAUnB,aAAa,OAAQ,UAC/BmB,UAAUnB,aAAa,OAAQ,aAC/BmB,UAAUnB,aAAa,QAASc,WAEhCG,KAAKpB,YAAYqB,YACjBD,KAAKpB,YAAYsB,WAEjBzC,aAAa0C,WAAWvB,YAAYoB,MAEpBtC,SAASC,iBAAiB,yBAAyB,GACzDyC,eAMpB,CACHC,KAAM,SAASnD,eACJ,IAAID,UAAUC"}
{"version":3,"file":"authmagic.min.js","sources":["../src/authmagic.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Magic authentication define js.\n * @module   auth_magic\n * @copyright  2023 bdecent gmbh <https://bdecent.de>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'core/ajax'],\nfunction(String, Ajax) {\n\n    /**\n    * Controls Custom styles tool action.\n    * @param {object} params\n    */\n    var AuthMagic = function(params) {\n        var self = this;\n        if (params.loginhook) {\n            self.magicLoginHook(params);\n        }\n        if (params.customloginhook) {\n            self.magicCustomLoginHook(params);\n        }\n        return true;\n    };\n\n    AuthMagic.prototype.magicCustomLoginHook = function(params) {\n        var self = this;\n        var MagicLink = self.getMagicLink(params, \"#page-local-magic-login\");\n        if (MagicLink) {\n            self.magicLoginHandler(MagicLink, \"form#login #id_email\", params);\n        }\n    };\n\n    AuthMagic.prototype.getMagicLink = function(params, linkId) {\n        var authSelector = linkId + \" .potentialidplist a[title=\\\"\" + params.strbutton + \"\\\"]\";\n        var MagicLink = \"\";\n        if (authSelector) {\n            MagicLink = document.querySelectorAll(authSelector)[0];\n            if (MagicLink === undefined) {\n                authSelector = linkId + \" .login-identityproviders a\";\n                var MagicLinks = document.querySelectorAll(authSelector);\n                if (MagicLinks.length) {\n                    MagicLinks.forEach(function(item) {\n                        var inner = item.innerHTML.trim();\n                        if (inner == params.strbutton) {\n                            MagicLink = item;\n                        }\n                    });\n                }\n            }\n        }\n        return MagicLink;\n    };\n\n    AuthMagic.prototype.magicLoginHook = function(params) {\n        var self = this;\n        var linkId = \"#page-login-index\";\n        var MagicLink = self.getMagicLink(params, linkId);\n        if (MagicLink) {\n            if (!document.querySelector(\"#page-login-index .potentialidplist\")) {\n                MagicLink.classList.remove(\"btn-secondary\");\n                MagicLink.classList.add(\"btn-primary\");\n                potentialiDpList = document.querySelectorAll(linkId + \" .login-identityproviders a\");\n                potentialiDp = document.querySelectorAll(linkId + \" .login-identityproviders h2\")[0];\n            } else {\n                var potentialiDp = document.querySelector(linkId + \" .potentialidplist\");\n                if (potentialiDp) {\n                    potentialiDp = potentialiDp.previousElementSibling;\n                }\n                var potentialiDpList = document.querySelectorAll(linkId + \" .potentialidplist .potentialidp\");\n            }\n            if (!params.linkbtnpos) {\n                params.linkbtnpos = 0;\n            }\n            if (params.linkbtnpos == 0) {\n                var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\n                if (MagicLinkBlock) {\n                    MagicLinkBlock.appendChild(MagicLink);\n                    // Create a span.\n                    var span = document.createElement(\"span\");\n                    span.setAttribute(\"class\", \"magic-password-instruction\");\n                    var passInfo = String.get_string('passinfo', 'auth_magic');\n                    passInfo.done(function(localizedEditString) {\n                        span.innerHTML = localizedEditString;\n                    });\n                    MagicLinkBlock.appendChild(span);\n                }\n            }\n            if (params.linkbtnpos == 1) {\n                var MagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\n                if (MagicLinkBlock) {\n                    MagicLinkBlock.appendChild(MagicLink);\n                }\n            }\n\n            if (params.linkbtnpos <= 1 ) {\n                if (potentialiDpList.length <= 1) {\n                    potentialiDp.style.display = 'none';\n                    var identityProvider = document.querySelectorAll(\"#page-login-index .login-identityproviders\")[0];\n                    if (identityProvider) {\n                        identityProvider.previousElementSibling.style.display = 'none';\n                        identityProvider.nextElementSibling.style.display = 'none';\n                    }\n                }\n            }\n\n            if (params.linkbtnpos == 2) {\n                MagicLink.classList.remove(\"btn-primary\");\n            }\n            self.magicLoginHandler(MagicLink, \"form#login #username\", params);\n        }\n    };\n\n    AuthMagic.prototype.getMagicLinkPassCheck = function() {\n        var emailElement = document.querySelector(\"form.login-form input[name=email]\");\n        var passwordElement = document.querySelector(\"form.login-form input[name=password]\");\n        var status = false;\n        if (emailElement && passwordElement) {\n            var args = {\n                email : emailElement.value,\n                password : passwordElement.value,\n            };\n            Ajax.call([{\n                methodname: 'auth_magic_get_magiclink_passcheck',\n                args: args,\n                done: function(response) {\n                    status = response.status;\n                }\n            }], status);\n        }\n        return status;\n    };\n\n    AuthMagic.prototype.magicLoginHandler = function(MagicLink, mailHandler, params) {\n        var self = this;\n        MagicLink.addEventListener(\"click\", function(e) {\n            e.preventDefault();\n            if (params.passcheck) {\n                // Wrong password condition give the redirect to the current data.\n                var loginformbutton = document.querySelector(\"form.login-form .magic-submit-action input\");\n                loginformbutton.click();\n            }\n\n            if (params.passcheck && !self.getMagicLinkPassCheck()) {\n                return \"\";\n            }\n            var returnurl = e.currentTarget.getAttribute(\"href\");\n            var userValue = \"\";\n            //form#login #username\n            var mailSelector = document.querySelectorAll(mailHandler)[0];\n            if (mailSelector) {\n                userValue = mailSelector.value;\n            }\n            // Create a form.\n            var form = document.createElement(\"form\");\n            form.setAttribute(\"method\", \"post\");\n            form.setAttribute(\"action\", returnurl);\n            form.setAttribute(\"id\", \"magic-login-form\");\n\n                // Create an input element for Full Name\n            var magicLogin = document.createElement(\"input\");\n            magicLogin.setAttribute(\"type\", \"hidden\");\n            magicLogin.setAttribute(\"name\", \"magiclogin\");\n            magicLogin.setAttribute(\"value\", 1);\n\n            var uservalue = document.createElement(\"input\");\n            uservalue.setAttribute(\"type\", \"hidden\");\n            uservalue.setAttribute(\"name\", \"uservalue\");\n            uservalue.setAttribute(\"value\", userValue);\n\n            form.appendChild(magicLogin);\n            form.appendChild(uservalue);\n\n            MagicLink.parentNode.appendChild(form);\n\n            var magicForm = document.querySelectorAll(\"form#magic-login-form\")[0];\n            magicForm.submit();\n        });\n    };\n\n    return {\n        init: function(params) {\n            return new AuthMagic(params);\n        }\n    };\n\n});"],"names":["define","String","Ajax","AuthMagic","params","loginhook","this","magicLoginHook","customloginhook","magicCustomLoginHook","prototype","MagicLink","getMagicLink","magicLoginHandler","linkId","authSelector","strbutton","undefined","document","querySelectorAll","MagicLinks","length","forEach","item","innerHTML","trim","querySelector","potentialiDp","previousElementSibling","potentialiDpList","classList","remove","add","MagicLinkBlock","linkbtnpos","appendChild","span","createElement","setAttribute","get_string","done","localizedEditString","style","display","identityProvider","nextElementSibling","getMagicLinkPassCheck","emailElement","passwordElement","status","args","email","value","password","call","methodname","response","mailHandler","self","addEventListener","e","preventDefault","passcheck","click","returnurl","currentTarget","getAttribute","userValue","mailSelector","form","magicLogin","uservalue","parentNode","submit","init"],"mappings":"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"}
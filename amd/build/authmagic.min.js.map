{"version":3,"file":"authmagic.min.js","sources":["../src/authmagic.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Magic authentication define js.\r\n * @module   auth_magic\r\n * @copyright  2023 bdecent gmbh <https://bdecent.de>\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['core/str'],\r\nfunction(String) {\r\n\r\n   /**\r\n    * Controls Custom styles tool action.\r\n    * @param {object} params\r\n    */\r\n   var AuthMagic = function(params) {\r\n       var self = this;\r\n       if (params.loginhook) {\r\n           self.magicLoginHook(params);\r\n       }\r\n       return true;\r\n   };\r\n\r\n   AuthMagic.prototype.magicLoginHook = function(params) {\r\n       var authSelector = \"#page-login-index .potentialidplist a[title=\\\"\" + params.strbutton + \"\\\"]\";\r\n       if (authSelector) {\r\n           var getMagicLink = document.querySelectorAll(authSelector)[0];\r\n           var potentialiDp = document.querySelector(\"#page-login-index .potentialidplist\");\r\n           if (potentialiDp) {\r\n               potentialiDp = potentialiDp.previousElementSibling;\r\n           }\r\n           var potentialiDpList = document.querySelectorAll(\"#page-login-index .potentialidplist .potentialidp\");\r\n           if (getMagicLink === undefined) {\r\n               authSelector = \"#page-login-index .login-identityproviders a\";\r\n               var getMagicLinks = document.querySelectorAll(authSelector);\r\n               if (getMagicLinks.length) {\r\n                   getMagicLinks.forEach(function(item) {\r\n                       var inner = item.innerHTML.trim();\r\n                       if (inner == params.strbutton) {\r\n                           getMagicLink = item;\r\n                           potentialiDpList = document.querySelectorAll(\"#page-login-index .login-identityproviders a\");\r\n                           potentialiDp = document.querySelectorAll(\"#page-login-index .login-identityproviders h2\")[0];\r\n                       }\r\n                   });\r\n               }\r\n           }\r\n            if (getMagicLink) {\r\n\r\n                if (!document.querySelector(\"#page-login-index .potentialidplist\")) {\r\n                    getMagicLink.classList.remove(\"btn-secondary\");\r\n                    getMagicLink.classList.add(\"btn-primary\");\r\n                }\r\n                if (!params.linkbtnpos) {\r\n                    params.linkbtnpos = 0;\r\n                }\r\n                if (params.linkbtnpos == 0) {\r\n                    var getMagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\r\n                    if (getMagicLinkBlock) {\r\n                        getMagicLinkBlock.appendChild(getMagicLink);\r\n                        // Create a span.\r\n                        var span = document.createElement(\"span\");\r\n                        span.setAttribute(\"class\", \"magic-password-instruction\");\r\n                        var passInfo = String.get_string('passinfo', 'auth_magic');\r\n                        $.when(passInfo).done(function(localizedEditString) {\r\n                            span.innerHTML = localizedEditString;\r\n                        });\r\n                        getMagicLinkBlock.appendChild(span);\r\n                    }\r\n                }\r\n                if (params.linkbtnpos == 1) {\r\n                    var getMagicLinkBlock = document.querySelectorAll(\"#page-login-index form#login .form-group\")[params.linkbtnpos];\r\n                    if (getMagicLinkBlock) {\r\n                        getMagicLinkBlock.appendChild(getMagicLink);\r\n                    }\r\n                }\r\n\r\n                if (params.linkbtnpos <= 1 ) {\r\n                    if (potentialiDpList.length <= 1) {\r\n                        potentialiDp.style.display = 'none';\r\n                        var identityProvider = document.querySelectorAll(\"#page-login-index .login-identityproviders\")[0];\r\n                        if (identityProvider) {\r\n                            identityProvider.previousElementSibling.style.display = 'none';\r\n                            identityProvider.nextElementSibling.style.display = 'none';\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (params.linkbtnpos == 2) {\r\n                    getMagicLink.classList.remove(\"btn-primary\");\r\n                }\r\n                getMagicLink.addEventListener(\"click\", function(e) {\r\n                    e.preventDefault();\r\n                    var returnurl = e.currentTarget.getAttribute(\"href\");\r\n                    var userValue = \"\";\r\n                    var mailSelector = document.querySelectorAll(\"form#login #username\")[0];\r\n                    if (mailSelector) {\r\n                        userValue = mailSelector.value;\r\n                    }\r\n                    // Create a form.\r\n                    var form = document.createElement(\"form\");\r\n                    form.setAttribute(\"method\", \"post\");\r\n                    form.setAttribute(\"action\", returnurl);\r\n                    form.setAttribute(\"id\", \"magic-login-form\");\r\n\r\n                        // Create an input element for Full Name\r\n                    var magicLogin = document.createElement(\"input\");\r\n                    magicLogin.setAttribute(\"type\", \"hidden\");\r\n                    magicLogin.setAttribute(\"name\", \"magiclogin\");\r\n                    magicLogin.setAttribute(\"value\", 1);\r\n\r\n                    var uservalue = document.createElement(\"input\");\r\n                    uservalue.setAttribute(\"type\", \"hidden\");\r\n                    uservalue.setAttribute(\"name\", \"uservalue\");\r\n                    uservalue.setAttribute(\"value\", userValue);\r\n\r\n                    form.appendChild(magicLogin);\r\n                    form.appendChild(uservalue);\r\n\r\n                    getMagicLink.parentNode.appendChild(form);\r\n\r\n                    var magicForm = document.querySelectorAll(\"form#magic-login-form\")[0];\r\n                    magicForm.submit();\r\n                });\r\n           }\r\n       }\r\n   };\r\n\r\n   return {\r\n       init: function(params) {\r\n           return new AuthMagic(params);\r\n       }\r\n   };\r\n\r\n});"],"names":["define","String","AuthMagic","params","loginhook","this","magicLoginHook","prototype","authSelector","strbutton","getMagicLink","document","querySelectorAll","potentialiDp","querySelector","previousElementSibling","potentialiDpList","undefined","getMagicLinks","length","forEach","item","innerHTML","trim","getMagicLinkBlock","classList","remove","add","linkbtnpos","appendChild","span","createElement","setAttribute","passInfo","get_string","$","when","done","localizedEditString","style","display","identityProvider","nextElementSibling","addEventListener","e","preventDefault","returnurl","currentTarget","getAttribute","userValue","mailSelector","value","form","magicLogin","uservalue","parentNode","submit","init"],"mappings":";;;;;;AAsBAA,8BAAO,CAAC,aACR,SAASC,QAMN,IAAIC,UAAY,SAASC,QAKrB,OAHIA,OAAOC,WADAC,KAEFC,eAAeH,SAEjB,GA2GX,OAxGAD,UAAUK,UAAUD,eAAiB,SAASH,QAC1C,IAAIK,aAAe,gDAAmDL,OAAOM,UAAY,KACzF,GAAID,aAAc,CACd,IAAIE,aAAeC,SAASC,iBAAiBJ,cAAc,GACvDK,aAAeF,SAASG,cAAc,uCACtCD,eACAA,aAAeA,aAAaE,wBAEhC,IAAIC,iBAAmBL,SAASC,iBAAiB,qDACjD,QAAqBK,IAAjBP,aAA4B,CAC5BF,aAAe,+CACf,IAAIU,cAAgBP,SAASC,iBAAiBJ,cAC1CU,cAAcC,QACdD,cAAcE,SAAQ,SAASC,MACfA,KAAKC,UAAUC,QACdpB,OAAOM,YAChBC,aAAeW,KACfL,iBAAmBL,SAASC,iBAAiB,gDAC7CC,aAAeF,SAASC,iBAAiB,iDAAiD,GAElG,GAER,CACC,GAAIF,aAAc,CAUV,IAcIc,kBAfR,GAPKb,SAASG,cAAc,yCACxBJ,aAAae,UAAUC,OAAO,iBAC9BhB,aAAae,UAAUE,IAAI,gBAE1BxB,OAAOyB,aACRzB,OAAOyB,WAAa,GAEC,GAArBzB,OAAOyB,WAEP,GADIJ,kBAAoBb,SAASC,iBAAiB,4CAA4CT,OAAOyB,YAC9E,CACnBJ,kBAAkBK,YAAYnB,cAE9B,IAAIoB,KAAOnB,SAASoB,cAAc,QAClCD,KAAKE,aAAa,QAAS,8BAC3B,IAAIC,SAAWhC,OAAOiC,WAAW,WAAY,cAC7CC,EAAEC,KAAKH,UAAUI,MAAK,SAASC,qBAC3BR,KAAKR,UAAYgB,mBACrB,IACAd,kBAAkBK,YAAYC,KAClC,CAEJ,GAAyB,GAArB3B,OAAOyB,YACHJ,kBAAoBb,SAASC,iBAAiB,4CAA4CT,OAAOyB,cAEjGJ,kBAAkBK,YAAYnB,cAItC,GAAIP,OAAOyB,YAAc,GACjBZ,iBAAiBG,QAAU,EAAG,CAC9BN,aAAa0B,MAAMC,QAAU,OAC7B,IAAIC,iBAAmB9B,SAASC,iBAAiB,8CAA8C,GAC3F6B,mBACAA,iBAAiB1B,uBAAuBwB,MAAMC,QAAU,OACxDC,iBAAiBC,mBAAmBH,MAAMC,QAAU,OAE5D,CAGqB,GAArBrC,OAAOyB,YACPlB,aAAae,UAAUC,OAAO,eAElChB,aAAaiC,iBAAiB,SAAS,SAASC,GAC5CA,EAAEC,iBACF,IAAIC,UAAYF,EAAEG,cAAcC,aAAa,QACzCC,UAAY,GACZC,aAAevC,SAASC,iBAAiB,wBAAwB,GACjEsC,eACAD,UAAYC,aAAaC,OAG7B,IAAIC,KAAOzC,SAASoB,cAAc,QAClCqB,KAAKpB,aAAa,SAAU,QAC5BoB,KAAKpB,aAAa,SAAUc,WAC5BM,KAAKpB,aAAa,KAAM,oBAGxB,IAAIqB,WAAa1C,SAASoB,cAAc,SACxCsB,WAAWrB,aAAa,OAAQ,UAChCqB,WAAWrB,aAAa,OAAQ,cAChCqB,WAAWrB,aAAa,QAAS,GAEjC,IAAIsB,UAAY3C,SAASoB,cAAc,SACvCuB,UAAUtB,aAAa,OAAQ,UAC/BsB,UAAUtB,aAAa,OAAQ,aAC/BsB,UAAUtB,aAAa,QAASiB,WAEhCG,KAAKvB,YAAYwB,YACjBD,KAAKvB,YAAYyB,WAEjB5C,aAAa6C,WAAW1B,YAAYuB,MAEpBzC,SAASC,iBAAiB,yBAAyB,GACzD4C,QACd,GACL,CACJ,GAGG,CACHC,KAAM,SAAStD,QACX,OAAO,IAAID,UAAUC,OACzB,EAGP"}